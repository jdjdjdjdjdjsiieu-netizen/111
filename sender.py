import asyncio
import logging
from telethon import TelegramClient
from telethon.tl.types import InputPeerUser
from db import get_all_contacts

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
# –í–ê–ñ–ù–û: –≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
from config import TELEGRAM_API_ID, TELEGRAM_API_HASH, TELEGRAM_PHONE_NUMBER

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
API_ID = TELEGRAM_API_ID
API_HASH = TELEGRAM_API_HASH
PHONE_NUMBER = TELEGRAM_PHONE_NUMBER
SESSION_NAME = "alfa_sender_session"

# –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–µ, —Å –ø—Ä–∏–∑—ã–≤–æ–º –∫ –±–æ—Ç—É)
# –í–ê–ñ–ù–û: –£–∫–∞–∂–∏—Ç–µ –∑–¥–µ—Å—å —Å—Å—ã–ª–∫—É –Ω–∞ –í–∞—à–µ–≥–æ Telegram-–±–æ—Ç–∞!
MESSAGE_TEMPLATE = """
–ü—Ä–∏–≤–µ—Ç, {name}! üëã
–Ø –Ω–∞—à–µ–ª –¥–ª—è —Ç–µ–±—è –æ—á–µ–Ω—å –∫—Ä—É—Ç—É—é –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å, —Å–≤—è–∑–∞–Ω–Ω—É—é —Å –ê–ª—å—Ñ–∞-–ë–∞–Ω–∫–æ–º. –≠—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –∫–∞—Ä—Ç–∞, –∞ —Ü–µ–ª–∞—è —Å–∏—Å—Ç–µ–º–∞ –∑–∞—Ä–∞–±–æ—Ç–∫–∞.

–Ø –∑–∞–ø—É—Å—Ç–∏–ª —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –±–æ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –∑–∞ 3 –º–∏–Ω—É—Ç—ã –ø–æ–¥–±–µ—Ä–µ—Ç —Ç–µ–±–µ —Å–∞–º—ã–π –≤—ã–≥–æ–¥–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç (–∫–∞—Ä—Ç—É, –∫—Ä–µ–¥–∏—Ç, —Å—á–µ—Ç) –∏ –ø–æ–∫–∞–∂–µ—Ç, –∫–∞–∫ –Ω–∞ —ç—Ç–æ–º –º–æ–∂–Ω–æ –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å.

–ü–µ—Ä–µ—Ö–æ–¥–∏, –ø–æ–∫–∞ –µ—Å—Ç—å –≤—Ä–µ–º—è: @[–ò–ú–Ø_–í–ê–®–ï–ì–û_–ë–û–¢–ê]
# –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ [–ò–ú–Ø_–í–ê–®–ï–ì–û_–ë–û–¢–ê] –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–µ –∏–º—è –±–æ—Ç–∞!
# –ù–∞–ø—Ä–∏–º–µ—Ä: –ü–µ—Ä–µ—Ö–æ–¥–∏, –ø–æ–∫–∞ –µ—Å—Ç—å –≤—Ä–µ–º—è: @AlfaPartnerBot
–≠—Ç–æ –ø—Ä–æ—Å—Ç–æ, –Ω–∏ –∫ —á–µ–º—É –Ω–µ –æ–±—è–∑—ã–≤–∞–µ—Ç, –Ω–æ –º–æ–∂–µ—Ç –ø—Ä–∏–Ω–µ—Å—Ç–∏ —Ç–µ–±–µ —Ö–æ—Ä–æ—à–∏–π –¥–æ—Ö–æ–¥. üòâ
"""

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

async def send_messages():
    """
    –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ —Ä–∞—Å—Å—ã–ª–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π.
    """
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞
    client = TelegramClient(SESSION_NAME, API_ID, API_HASH)
    
    try:
        logging.info("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Telegram...")
        await client.start(phone=PHONE_NUMBER)
        logging.info("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ. –ê–∫–∫–∞—É–Ω—Ç: %s", await client.get_me())

        # –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç–∞
        contacts = get_all_contacts()
        if not contacts:
            logging.warning("–ë–∞–∑–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –ø—É—Å—Ç–∞. –†–∞—Å—Å—ã–ª–∫–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞.")
            return

        logging.info("–ù–∞–π–¥–µ–Ω–æ %d –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏.", len(contacts))
        
        for contact in contacts:
            # contact: (id, name, phone, note)
            contact_id, name, phone, note = contact
            
            if not phone:
                logging.warning("–ö–æ–Ω—Ç–∞–∫—Ç ID %d (%s) –Ω–µ –∏–º–µ–µ—Ç –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º.", contact_id, name)
                continue

            # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞
            # Telethon –ª—É—á—à–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ø–æ–ª–Ω—ã–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏, –Ω–æ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ, —á—Ç–æ –µ—Å—Ç—å
            target_phone = phone.strip().replace(' ', '').replace('-', '').replace('(', '').replace(')', '')
            
            # –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
            first_name = name.split()[0] if name else "–¥—Ä—É–≥"
            message_text = MESSAGE_TEMPLATE.format(name=first_name)
            
            try:
                # –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                user = await client.get_entity(target_phone)
                
                # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
                await client.send_message(user, message_text)
                logging.info("–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∫–æ–Ω—Ç–∞–∫—Ç—É: %s (%s)", name, target_phone)
                
                # –í–ê–ñ–ù–û: –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
                await asyncio.sleep(5) # –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ—Ç 5 –¥–æ 15 —Å–µ–∫—É–Ω–¥
                
            except Exception as e:
                logging.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–Ω—Ç–∞–∫—Ç—É %s (%s): %s", name, target_phone, e)
                # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏
                await asyncio.sleep(10)

    except Exception as e:
        logging.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞: %s", e)
        
    finally:
        await client.disconnect()
        logging.info("–ö–ª–∏–µ–Ω—Ç Telegram –æ—Ç–∫–ª—é—á–µ–Ω.")

if __name__ == '__main__':
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
    # –í–ê–ñ–ù–û: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ db.py –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ç–æ–π –∂–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    # init_db() # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ main.py, –Ω–æ –ª—É—á—à–µ —É–±–µ–¥–∏—Ç—å—Å—è
    
    # –ó–∞–ø—É—Å–∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
    try:
        asyncio.run(send_messages())
    except KeyboardInterrupt:
        logging.info("–†–∞—Å—Å—ã–ª–∫–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.")
    except Exception as e:
        logging.error("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: %s", e)
